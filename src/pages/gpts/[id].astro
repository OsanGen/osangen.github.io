---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProofIOBlock from '../../components/ProofIOBlock.astro';
import TagList from '../../components/TagList.astro';
import { loadGPTs } from '../../lib/content';
import { isExternalUrl, isUnavailableLink } from '../../lib/link-utils';
import type { GPT } from '../../lib/schemas';

export async function getStaticPaths() {
  const gpts = await loadGPTs();
  return gpts.map((gpt) => ({
    params: {
      id: gpt.id,
    },
    props: {
      gpt,
    },
  }));
}

const { gpt } = Astro.props as { gpt?: GPT };

interface CtaState {
  href: string;
  isExternal: boolean;
  visible: boolean;
}

const isExternal = (href = '') => isExternalUrl(href);

const deriveCta = (rawHref: string | undefined): CtaState => {
  const href = rawHref?.trim() ?? '';

  if (isUnavailableLink(href)) {
    return { href: '', isExternal: false, visible: false };
  }

  return {
    href,
    isExternal: isExternal(href),
    visible: true,
  };
};

const formatFallbackText = (raw: string | undefined, fallback: string) =>
  raw?.trim() ? raw : fallback;

const useCta = deriveCta(gpt?.links?.use);
const promptPackCta = deriveCta(gpt?.links?.promptPack);
const demoCta = deriveCta(gpt?.links?.demo);
const useCopy = formatFallbackText(gpt?.links.use, 'Public agent link coming soon.');
const promptCopy = formatFallbackText(gpt?.links.promptPack, 'Prompt pack pending.');
const demoCopy = formatFallbackText(gpt?.links.demo, 'Demo pending.');
---
<BaseLayout title={gpt ? `${gpt.name} | Lean Agents` : 'Agent not found'} description="Lean agent detail with usage, proof, and limits.">
  {gpt ? (
    <div class="page-shell">
      <section class="hero-shell scene-shell cog-proof-stack" data-motion-enter>
        <p class="hero-eyebrow">Lean Agent detail</p>
        <h1>{gpt.name}</h1>
        <p class="text-small deck-subtitle">{gpt.short_desc}</p>
        <p class="text-small"><strong>Outcome:</strong> {gpt.ships}</p>
        <p class="muted"><strong>Audience:</strong> {gpt.audience.join(' / ')}</p>
        <TagList tags={gpt.tags} compact maxItems={3} />
        <div class="cta-stack">
          {useCta.visible ? (
            <a
              href={useCta.href}
              class="button button--primary"
              target={useCta.isExternal ? '_blank' : undefined}
              rel={useCta.isExternal ? 'noopener noreferrer' : undefined}
            >
              Open agent
            </a>
          ) : (
            <span class="text-small">{useCopy}</span>
          )}
          <a href="/gpts" class="button">Back to directory</a>
        </div>
      </section>

      <section class="panel-shell cog-proof-stack" data-motion-enter>
        <h2>Proof</h2>
        <ProofIOBlock proof={gpt.proof} mode="full" />
      </section>

      <section class="panel-shell cog-proof-stack" data-motion-enter>
        <h2>How to use</h2>
        <ol class="gpt-steps" data-motion-group>
          {gpt.how_to_use.map((step) => <li>{step}</li>)}
        </ol>
      </section>

      <section class="panel-shell cog-proof-stack" data-motion-enter>
        <h2>Limits</h2>
        <ul class="gpt-limits" data-motion-group>
          {gpt.limits.map((limit) => <li>{limit}</li>)}
        </ul>
      </section>

      <section class="panel-shell cog-proof-stack" data-motion-enter>
        <h2>Additional resources</h2>
        <div class="cta-stack">
          {promptPackCta.visible ? (
            <a
              class="button"
              href={promptPackCta.href}
              target={promptPackCta.isExternal ? '_blank' : undefined}
              rel={promptPackCta.isExternal ? 'noopener noreferrer' : undefined}
            >
              Prompt pack
            </a>
          ) : (
            <span class="text-small">{promptCopy}</span>
          )}
          {demoCta.visible ? (
            <a
              class="button"
              href={demoCta.href}
              target={demoCta.isExternal ? '_blank' : undefined}
              rel={demoCta.isExternal ? 'noopener noreferrer' : undefined}
            >
              Open demo
            </a>
          ) : (
            <span class="text-small">{demoCopy}</span>
          )}
        </div>
      </section>
    </div>
  ) : (
    <section class="panel-shell">
      <h1>Agent not found</h1>
      <p class="text-small">Return to Lean Agents to open an available entry.</p>
      <a href="/gpts" class="button">Back to Lean Agents</a>
    </section>
  )}
</BaseLayout>
