---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TagList from '../../components/TagList.astro';
import type { Workshop } from '../../lib/schemas';
import { loadWorkshops } from '../../lib/content';
import { isExternalUrl, isUnavailableLink } from '../../lib/link-utils';
import { isCoreWorkshopId } from '../../lib/workshop-catalog';

interface CtaState {
  href: string;
  isExternal: boolean;
  visible: boolean;
  label: string;
}

export async function getStaticPaths() {
  const workshops = await loadWorkshops();
  return workshops
    .filter((workshop: Workshop) => isCoreWorkshopId(workshop.id))
    .map((workshop: Workshop) => ({
      params: {
        id: workshop.id,
      },
      props: {
        workshop,
      },
    }));
}

const { workshop } = Astro.props as { workshop?: Workshop };

const isExternal = (href = '') => isExternalUrl(href);

const formatFallbackText = (value: string | undefined, fallback: string) => value?.trim() || fallback;

const deriveCta = (workshop?: Workshop): CtaState => {
  const replayHref = workshop?.replayUrl?.trim() ?? '';
  const slidesHref = workshop?.slidesUrl?.trim() ?? '';
  const detailHref = workshop?.id?.trim() ? `/workshops/${workshop.id.trim()}` : '';

  if (replayHref && !isUnavailableLink(replayHref)) {
    return {
      href: replayHref,
      isExternal: isExternal(replayHref),
      visible: true,
      label: 'Replay',
    };
  }

  if (slidesHref && !isUnavailableLink(slidesHref)) {
    return {
      href: slidesHref,
      isExternal: isExternal(slidesHref),
      visible: true,
      label: 'Slides',
    };
  }

  if (!detailHref || isUnavailableLink(detailHref)) {
    return {
      href: '',
      isExternal: false,
      visible: false,
      label: 'Open details',
    };
  }

  return {
    href: detailHref,
    isExternal: false,
    visible: true,
    label: 'Open details',
  };
};

const action = deriveCta(workshop);
const audienceLine = workshop?.audienceLine?.trim();
const hasProofLine = Boolean(workshop?.proofLine?.trim());
const hasTeachingBullets = Boolean(workshop?.teachingBullets?.length);
const proofSubtitle = workshop?.proofLine?.trim() || '';
const hasPlayCta = action.visible && action.label !== 'Open details';
const ctaCopy = formatFallbackText(workshop?.replayUrl || workshop?.slidesUrl, 'Proof is coming soon.');
---
<BaseLayout title={workshop ? `${workshop.title} | Oscar Sanchez` : 'Workshop not found'} description={workshop ? workshop.description : 'Workshop details'}>
  {workshop ? (
    <div class="page-shell">
      <section class="panel-shell learn-hero learn-detail-hero">
        <div class="learn-detail-hero__top">
          <div class="learn-detail-hero__content">
            <p class="eyebrow learn-hero__eyebrow">
              <span class="learn-hero__dot" aria-hidden="true"></span>
              Workshop
            </p>
            <h1>{workshop.title}</h1>
            <p class="text-small muted">{workshop.date}</p>
            {proofSubtitle ? <p class="learn-hero__subtitle">{proofSubtitle}</p> : null}
            {workshop.tags.length > 0 ? <TagList tags={workshop.tags} compact maxItems={4} /> : null}
          </div>

          <div class="learn-detail-hero__cta">
            {hasPlayCta ? (
              <a
                class="button button--primary"
                href={action.href}
                target={action.isExternal ? '_blank' : undefined}
                rel={action.isExternal ? 'noopener noreferrer' : undefined}
              >
                {action.label}
              </a>
            ) : (
              <p class="text-small muted">{ctaCopy}</p>
            )}
          </div>
        </div>
      </section>

      <section class="panel-shell">
        <h2>Summary</h2>
        <p class="text-small">{workshop.description}</p>
        {audienceLine ? <p class="text-small muted">Audience: {audienceLine}</p> : null}
      </section>

      <section class="panel-shell">
        <details class="agent-details" open>
          <summary>Proof</summary>
          <div class="agent-details-body">
            {hasProofLine ? <p>{workshop.proofLine}</p> : <p class="muted">Add a proof line to enrich this detail page.</p>}
          </div>
        </details>
      </section>

      <section class="panel-shell">
        {hasTeachingBullets ? (
          <details class="agent-details">
            <summary>Teaching bullets</summary>
            <div class="agent-details-body">
              <ol>
                {workshop.teachingBullets?.map((bullet) => <li>{bullet}</li>)}
              </ol>
            </div>
          </details>
        ) : (
          <p class="text-small muted">No teaching bullets published yet.</p>
        )}
      </section>

      <section class="panel-shell">
        <a class="button" href="/workshops">Back to Learn</a>
      </section>
    </div>
  ) : (
    <section class="panel-shell">
      <h1>Workshop not found</h1>
      <p class="text-small">This workshop is not available yet.</p>
      <a class="button" href="/workshops">Back to Learn</a>
    </section>
  )}
</BaseLayout>
