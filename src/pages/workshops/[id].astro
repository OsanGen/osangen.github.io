---
import BaseLayout from '../../layouts/BaseLayout.astro';
import type { Workshop } from '../../lib/schemas';
import { loadWorkshops } from '../../lib/content';
import { isExternalUrl, isUnavailableLink } from '../../lib/link-utils';
import { isCoreWorkshopId } from '../../lib/workshop-catalog';

interface CtaState {
  href: string;
  isExternal: boolean;
  visible: boolean;
}

export async function getStaticPaths() {
  const workshops = await loadWorkshops();
  return workshops
    .filter((workshop: Workshop) => isCoreWorkshopId(workshop.id))
    .map((workshop: Workshop) => ({
      params: {
        id: workshop.id,
      },
      props: {
        workshop,
      },
    }));
}

const { workshop } = Astro.props as { workshop?: Workshop };

const isExternal = (href = '') => isExternalUrl(href);

const formatFallbackText = (value: string | undefined, fallback: string) => value?.trim() || fallback;

const deriveCta = (workshop?: Workshop): CtaState => {
  const replayHref = workshop?.replayUrl?.trim() ?? '';
  const slidesHref = workshop?.slidesUrl?.trim() ?? '';
  const href = replayHref || slidesHref || `/workshops/${workshop?.id ?? ''}`;

  if (!href || isUnavailableLink(href)) {
    return {
      href: '',
      isExternal: false,
      visible: false,
    };
  }

  return {
    href,
    isExternal: isExternal(href),
    visible: true,
  };
};

const action = deriveCta(workshop);
const audienceLine = workshop?.audienceLine?.trim();
const hasProofLine = Boolean(workshop?.proofLine?.trim());
const hasTeachingBullets = Boolean(workshop?.teachingBullets?.length);
const actionLabel = workshop?.replayUrl
  ? 'Replay'
  : workshop?.slidesUrl
    ? 'Slides'
    : 'Open details';
const ctaCopy = formatFallbackText(workshop?.replayUrl || workshop?.slidesUrl, 'Proof or workshop content is coming soon.');
---
<BaseLayout title={workshop ? `${workshop.title} | Oscar Sanchez` : 'Workshop not found'} description={workshop ? workshop.description : 'Workshop details'}>
  {workshop ? (
    <div class="page-shell">
      <section class="hero-shell scene-shell command-shell scene-accent" style="--scene-accent: var(--cog-blue);">
        <p class="hero-eyebrow">Workshop detail</p>
        <h1>{workshop.title}</h1>
        <p class="text-small deck-subtitle">{workshop.date}</p>
      </section>

      <section class="panel-shell">
        <h2>Description</h2>
        <p class="text-small">{workshop.description}</p>
        {audienceLine ? <p class="text-small muted">Audience: {audienceLine}</p> : null}
      </section>

      <section class="panel-shell">
        <details class="agent-details" open>
          <summary>Proof</summary>
          <div class="agent-details-body">
            {hasProofLine ? <p>{workshop.proofLine}</p> : <p class="muted">Add a proof line to enrich this detail page.</p>}
          </div>
        </details>
      </section>

      <section class="panel-shell">
        {hasTeachingBullets ? (
          <details class="agent-details">
            <summary>Teaching bullets</summary>
            <div class="agent-details-body">
              <ol>
                {workshop.teachingBullets?.map((bullet) => <li>{bullet}</li>)}
              </ol>
            </div>
          </details>
        ) : (
          <p class="text-small muted">No teaching bullets published yet.</p>
        )}
      </section>

      {action.visible ? (
        <section class="panel-shell">
          <h2>Play</h2>
          <a
            class="button button--primary"
            href={action.href}
            target={action.isExternal ? '_blank' : undefined}
            rel={action.isExternal ? 'noopener noreferrer' : undefined}
          >
            {actionLabel}
          </a>
        </section>
      ) : (
        <section class="panel-shell">
          <h2>Play</h2>
          <p class="text-small">{ctaCopy}</p>
        </section>
      )}

      <section class="panel-shell">
        <a class="button" href="/workshops">Back to Learn</a>
      </section>
    </div>
  ) : (
    <section class="panel-shell">
      <h1>Workshop not found</h1>
      <p class="text-small">This workshop is not available yet.</p>
      <a class="button" href="/workshops">Back to Learn</a>
    </section>
  )}
</BaseLayout>
