---
import BaseLayout from '../layouts/BaseLayout.astro';
import { isUnavailableLink, sanitizeLink } from '../lib/link-utils';
import joinProject from '../content/data/join_project.json';

const {
  eyebrow,
  title,
  lede,
  highLevelScopeTitle,
  scopeChips,
  impactTitle,
  impactOneLiner,
  ctaLabel,
  ctaHref,
  secondaryLinkLabel,
  secondaryLinkHref,
  finePrint,
} = joinProject;

const resolvedCtaHref = sanitizeLink(ctaHref || '');
const isApplyPlaceholder = resolvedCtaHref === 'INTERNSHIP_APPLY_URL';
const resolvedSecondaryHref = sanitizeLink(secondaryLinkHref || '');
const hasPrimaryCta = resolvedCtaHref && !isUnavailableLink(resolvedCtaHref) && !isApplyPlaceholder;
const hasSecondaryLink = resolvedSecondaryHref && !isUnavailableLink(resolvedSecondaryHref);

const visibleChips = scopeChips?.slice(0, 6) ?? [];
---
<BaseLayout title="Apply - Oscar Sanchez" description="Apply to the GENMRKT internship project. Learn by shipping public good tooling.">
  <div class="join-landing scene-shell">
    <section class="hero-shell scene-accent" style="--scene-accent: var(--cog-blue);">
      <p class="hero-eyebrow">{eyebrow}</p>
      <h1>{title}</h1>
      <p class="text-small deck-subtitle line-clamp-2">{lede}</p>
      <div class="join-cta-stack">
        <div class="join-cta-row">
          {hasPrimaryCta ? (
            <a
              class="button button--primary join-cta"
              href={resolvedCtaHref}
              target="_blank"
              rel="noopener noreferrer"
              aria-label="Sign up on GENMRKT (opens in new tab)"
            >
              {ctaLabel}
            </a>
          ) : null}
          {hasSecondaryLink ? (
            <a
              class="join-url-chip"
              href={resolvedSecondaryHref}
              target="_blank"
              rel="noopener noreferrer"
            >
              {secondaryLinkLabel}
            </a>
          ) : null}
          {!hasPrimaryCta && !hasSecondaryLink ? (
            <p class="text-small muted">Set INTERNSHIP_APPLY_URL in join_project.json to publish the application CTA.</p>
          ) : null}
        </div>
        {hasPrimaryCta || hasSecondaryLink ? (
          <p class="text-small muted join-cta-note">Open signup page in new tab.</p>
        ) : null}
      </div>
      <p class="text-small muted">{finePrint}</p>
    </section>

    <section class="panel-shell">
      <h2>{highLevelScopeTitle}</h2>
      <div class="join-scope-grid" aria-label="Scope chips">
        {visibleChips.map((chip) => (
          <span class="proof-chip">{chip}</span>
        ))}
      </div>
      <p class="text-small muted">{impactTitle}</p>
      <p class="text-small line-clamp-2">{impactOneLiner}</p>
    </section>
  </div>
</BaseLayout>

<style>
  .join-landing {
    display: grid;
    grid-template-columns: minmax(0, 1.1fr) minmax(320px, 0.85fr);
    gap: var(--space-4);
    align-items: start;
    max-width: min(1100px, calc(100vw - 2rem));
    margin: 0 auto;
  }

  .join-cta-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: var(--space-2);
  }

  .join-cta-stack {
    display: grid;
    gap: 0.4rem;
  }

  .join-cta {
    min-height: 44px;
    min-width: 11.5rem;
  }

  .join-url-chip {
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    border-radius: var(--radius-pill);
    border: 1px solid color-mix(in srgb, var(--scene-accent, var(--accent)) 34%, var(--stroke));
    background: color-mix(in srgb, var(--surface) 85%, var(--panel));
    padding: 0.62rem 0.95rem;
    font-size: 0.86rem;
    text-decoration: none;
    line-height: 1.15;
    color: var(--ink-soft);
    transition: transform var(--motion-entrance) ease, border-color 160ms ease, color 160ms ease;
  }

  .join-url-chip::after {
    content: '->';
    font-size: 0.78rem;
    opacity: 0.72;
  }

  .join-url-chip:hover,
  .join-url-chip:focus-visible {
    transform: translateY(-1px);
    color: var(--ink);
    border-color: color-mix(in srgb, var(--scene-accent, var(--accent)) 68%, var(--ink));
  }

  .join-cta-note {
    letter-spacing: 0.01em;
  }

  .join-scope-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.45rem;
  }

  @media (max-width: 920px) {
    .join-landing {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 560px) {
    .join-cta-row {
      width: 100%;
      flex-direction: column;
      align-items: stretch;
    }

    .join-cta,
    .join-url-chip {
      width: 100%;
      justify-content: center;
    }

    .join-scope-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
