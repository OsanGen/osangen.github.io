---
import BaseLayout from '../layouts/BaseLayout.astro';
import { loadGames, loadModules, loadWorkshops } from '../lib/content';
import Card from '../components/Card.astro';
import CardGrid from '../components/CardGrid.astro';
import { sanitizeLink } from '../lib/link-utils';
import { isDisplayableVisualClassModule, splitWorkshops } from '../lib/workshop-catalog';

const [games, modules, workshops] = await Promise.all([
  loadGames(),
  loadModules(),
  loadWorkshops(),
]);

const { coreWorkshops, visualClassWorkshops } = splitWorkshops(workshops);
const moduleVisualClassCount = modules.filter(isDisplayableVisualClassModule).length;
const visualClassCount = moduleVisualClassCount + visualClassWorkshops.length;

const pluralize = (count: number, singular: string, plural: string) =>
  `${count} ${count === 1 ? singular : plural}`;

const routeCards = [
  {
    title: 'OSAN GAMES',
    href: '/labs',
    subtitle: pluralize(games.length, 'game', 'games'),
    action: 'Open OSAN games',
  },
  {
    title: 'Workshops',
    href: '/workshops',
    subtitle: pluralize(coreWorkshops.length, 'workshop', 'workshops'),
    action: 'Open workshops',
  },
  {
    title: 'Visual Classes',
    href: '/visual-classes',
    subtitle: pluralize(visualClassCount, 'visual class', 'visual classes'),
    action: 'Open visual classes',
  },
  {
    title: 'Contribute',
    href: '/join',
    subtitle: 'Open-source contribution',
    action: 'View opportunity',
  },
];

const bookHref = sanitizeLink('https://calendly.com/abellou/30min');
const visualClassSummary =
  `${visualClassCount} ${visualClassCount === 1 ? 'visual class' : 'visual classes'} and growing public content.`;
---
<BaseLayout title="Oscar Sanchez" description="Open-source AI education, cleanly.">
  <section class="hero-shell scene-shell command-shell">
    <p class="hero-eyebrow">Open-source AI education</p>
    <h1>Choose your route. Learn fast.</h1>
    <p class="text-small deck-subtitle">Four clean paths for shipping AI capability: play, learn, and contribute.</p>
    <div class="cta-stack">
      <a class="button button--primary" href="/labs">Open OSAN Games</a>
      <a class="button" href={bookHref} target="_blank" rel="noopener noreferrer">Book</a>
    </div>
    <p class="muted">Plus {visualClassSummary}</p>
  </section>

  <div class="route-grid">
    <CardGrid gap="var(--space-3)" align="start">
      {routeCards.map((card, index) => (
        <Card>
          <article
            class="route-card cog-entrance"
            style={`--reveal-delay:${index * 60}ms;`}
          >
            <h2>{card.title}</h2>
            <p class="text-small">{card.subtitle}</p>
            <a class="button button--ghost" href={card.href}>
              {card.action}
            </a>
          </article>
        </Card>
      ))}
    </CardGrid>
  </div>
</BaseLayout>
