---
import BaseLayout from '../layouts/BaseLayout.astro';
import Card from '../components/Card.astro';
import CardGrid from '../components/CardGrid.astro';
import TagList from '../components/TagList.astro';
import { loadWorkshops, loadModules, loadProfile, loadLastModifiedISO } from '../lib/content';
import EmptyState from '../components/EmptyState.astro';

const [profile, workshops, modules] = await Promise.all([
  loadProfile(),
  loadWorkshops(),
  loadModules(),
]);
const updated = await loadLastModifiedISO('workshops.json');
const visualModules = modules.filter((module) => Boolean(module.visualClass));
const workshopGuides = {
  'kinetic-kitchen-2-0': {
    primaryLabel: 'Open live experience',
    secondaryLabel: 'How this teaches',
    secondaryHref: '/workshops#kinetic-kitchen-teaching',
    teachingTitle: 'How The Kinetic Kitchen 2.0 teaches',
    teachingBullets: [
      'Order enters as a request and travels through stations.',
      'Route decisions are visible and explainable.',
      'Escalation is explicit when confidence is low.',
      'Throughput and accuracy are tracked as behavior changes.',
    ],
    proofLine:
      'A compact, visible workflow simulation that makes routing, guardrails, and outcomes explicit so learners can follow policy reasoning and spot failure modes quickly.',
  },
  'policy-gatekeeper': {
    primaryLabel: 'Open live experience',
    secondaryLabel: 'How this teaches',
    secondaryHref: '/workshops#policy-gatekeeper-teaching',
    teachingTitle: 'How Policy Gatekeeper teaches',
    teachingBullets: [
      'Tickets enter as requests and are routed by policy lanes.',
      'Policy checks are surfaced before any move is applied.',
      'Weak-confidence decisions are explicitly escalated for review.',
      'Outcome status updates show why a policy route was chosen or rejected.',
    ],
    proofLine:
      'A visual policy-routing environment for teaching rule design with explicit escalation, guardrails, and visible decision outcomes.',
  },
} as const;
const isExternalLink = (url: string) => /^https?:\/\//i.test(url.trim());
const getWorkshopGuide = (id: string) => workshopGuides[id as keyof typeof workshopGuides];
const hasGuide = (id: string) => Object.prototype.hasOwnProperty.call(workshopGuides, id);
const guidedWorkshops = workshops.filter((w) => hasGuide(w.id));
---
<BaseLayout title="Workshops - Oscar Sanchez" description="Workshop archive and import flow">
  <h1>Visuals & Workshops</h1>
  <p class="text-small">One place for image-first teaching assets, workshop links, and reusable resources.</p>
  <p class="text-small">Last updated: {updated ? new Date(updated).toLocaleString() : 'Not available'}</p>

  <section class="panel-shell">
    <h2>Open workshops</h2>
    {workshops.length === 0 ? (
      <EmptyState
        title="Add workshops"
        body="No workshop entries yet. Add data to src/content/data/workshops.json or import from LinkedIn."
        note="Run: npm run import:workshops"
      />
    ) : (
      <CardGrid gap="var(--space-3)" align="start">
        {workshops.map((w) => {
          const guide = getWorkshopGuide(w.id);
          return (
            <Card>
              <h3>{w.title}</h3>
              <p class="text-small">{w.date}</p>
              <p style="margin-top:0.5rem;">{w.description}</p>
              <div class="cta-stack" style="margin-top:0.6rem;">
                {w.replayUrl ? (
                  <a
                    class={`button ${guide ? 'button--primary' : ''}`}
                    href={w.replayUrl}
                    target={isExternalLink(w.replayUrl) ? '_blank' : undefined}
                    rel={isExternalLink(w.replayUrl) ? 'noopener noreferrer' : undefined}
                  >
                    {guide ? guide.primaryLabel : 'Replay'}
                  </a>
                ) : (
                  <span class="text-small">{guide ? 'Live experience unavailable' : 'Replay missing'}</span>
                )}
                {w.slidesUrl ? (
                  <a
                    class="button"
                    href={guide ? guide.secondaryHref : w.slidesUrl}
                    target={guide ? undefined : isExternalLink(w.slidesUrl) ? '_blank' : undefined}
                    rel={guide ? undefined : isExternalLink(w.slidesUrl) ? 'noopener noreferrer' : undefined}
                  >
                    {guide ? guide.secondaryLabel : 'Slides'}
                  </a>
                ) : (
                  <span class="text-small">{guide ? 'Teaching notes unavailable' : 'Slides missing'}</span>
                )}
              </div>
            </Card>
          );
        })}
      </CardGrid>
    )}
  </section>

  {guidedWorkshops.length > 0 ? (
    <section class="panel-shell">
      <h2>How these visuals teach</h2>
      <CardGrid gap="var(--space-3)" align="start">
        {guidedWorkshops.map((w) => {
          const guide = getWorkshopGuide(w.id);
          if (!guide) {
            return null;
          }

          return (
            <section id={`${w.id}-teaching`} class="panel-shell">
              <h3>{guide.teachingTitle}</h3>
              <p class="text-small">{guide.proofLine}</p>
              <ol class="catalog-summary">
                {guide.teachingBullets.map((step) => (
                  <li>{step}</li>
                ))}
              </ol>
            </section>
          );
        })}
      </CardGrid>
    </section>
  ) : null}

  <section class="panel-shell">
    <h2>Image-based visual learning</h2>
    {visualModules.length === 0 ? (
      <p class="text-small">No visual modules yet. Add a <code>visualClass</code> block to teaching modules to surface here.</p>
    ) : (
      <CardGrid gap="var(--space-3)" align="start">
        {visualModules.map((module) => (
          <Card>
            <h3>{module.title}</h3>
            <p class="text-small">{module.time} Â· {module.level}</p>
            <TagList tags={module.topics} compact maxItems={3} />
            <p class="catalog-summary">{module.format}</p>
            <a class="button catalog-cta" href={module.cta.href}>Open visual class</a>
          </Card>
        ))}
      </CardGrid>
    )}
  </section>

  <section class="panel-shell">
    <h2>Latest tools and links</h2>
    <p class="text-small">Primary source of open-source activity and announcements.</p>
    <CardGrid gap="var(--space-3)" align="start">
      <Card>
        <h3>LinkedIn</h3>
        <p class="text-small">Follow updates, workshops, and new teaching drops.</p>
        <a class="button button--primary" href={profile.links.linkedin} target="_blank" rel="noopener noreferrer">
          Open LinkedIn
        </a>
      </Card>
      <Card>
        <h3>Portfolio</h3>
        <p class="text-small">Long-form profile, repos, and external references.</p>
        <a class="button" href={profile.links.portfolio} target="_blank" rel="noopener noreferrer">
          Open portfolio
        </a>
      </Card>
      {profile.links.youtube ? (
        <Card>
          <h3>YouTube</h3>
          <p class="text-small">Replays, walkthroughs, and public sessions.</p>
          <a class="button" href={profile.links.youtube} target="_blank" rel="noopener noreferrer">Open channel</a>
        </Card>
      ) : null}
    </CardGrid>
  </section>

  <Card>
    <h2>How to add workshops</h2>
    <p class="text-small">Provide a JSON or CSV file under private/linkedin/workshops.json or workshops.csv and run import:workshops.</p>
    <p class="text-small"><a href="/docs">See docs for intake details</a></p>
  </Card>
</BaseLayout>
