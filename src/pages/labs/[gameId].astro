---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Card from '../../components/Card.astro';
import TagList from '../../components/TagList.astro';
import GameEmbed from '../../components/GameEmbed.astro';
import { loadGames } from '../../lib/content';
import { isExternalUrl, isUnavailableLink, sanitizeLink } from '../../lib/link-utils';
import type { Game } from '../../lib/schemas';

interface CtaState {
  href: string;
  isExternal: boolean;
  enabled: boolean;
}

export async function getStaticPaths() {
  const games = await loadGames();
  return games.map((game) => ({
    params: {
      gameId: game.id,
    },
    props: {
      game,
    },
  }));
}

const { game } = Astro.props as { game?: Game };

const isExternal = (href = '') => isExternalUrl(href);
const formatFallbackText = (value: string | undefined, fallback: string) => value?.trim() || fallback;

const deriveRepoCta = (rawUrl: string | undefined): CtaState => {
  const href = sanitizeLink(rawUrl || '');

  if (!href || isUnavailableLink(href)) {
    return {
      href: '',
      isExternal: false,
      enabled: false,
    };
  }

  return {
    href,
    isExternal: isExternal(href),
    enabled: true,
  };
};

const repoCta = game ? deriveRepoCta(game.repoUrl) : { href: '', isExternal: false, enabled: false };
const playCtaHref = sanitizeLink(game?.deployUrl || '');
const playCta = {
  href: playCtaHref,
  isExternal: isExternal(playCtaHref),
};
const playFallback = formatFallbackText(game?.deployUrl, 'Open in new tab link unavailable.');
---
<BaseLayout title={game ? `${game.title} - Labs` : 'Lab not found'} description="Game detail page">
  {game ? (
    <>
      <h1>{game.title}</h1>
      <p class="text-small">{game.tagline}</p>
      <TagList tags={game.concepts} />

      <Card>
        <h2>What you learn</h2>
        <ul>
          {game.learn.map((item) => <li>{item}</li>)}
        </ul>
      </Card>

      <h2 style="margin-top:1rem;">Play</h2>
      {playCta.href ? (
        <GameEmbed
          url={playCta.href}
          title={game.title}
          preferred={game.embed.preferred}
          aspectRatio={game.embed.aspectRatio as '16/9' | '4/3'}
        />
      ) : (
        <Card>
          <p class="text-small">{playFallback}</p>
        </Card>
      )}

      <Card>
        <h2>Controls</h2>
        <p class="text-small">Move: WASD. Shoot: Arrow keys.</p>
      </Card>

      <Card>
        <h2>Proof and links</h2>
        <div style="display:flex; gap:0.6rem; flex-wrap:wrap; margin-top:0.7rem;">
          {playCta.href ? (
            <a class="button" href={playCta.href} target={playCta.isExternal ? '_blank' : undefined} rel={playCta.isExternal ? 'noopener noreferrer' : undefined}>Open in new tab</a>
          ) : null}
          {repoCta.enabled ? (
            <a class="button" href={repoCta.href} target={repoCta.isExternal ? '_blank' : undefined} rel={repoCta.isExternal ? 'noopener noreferrer' : undefined}>
              Repo
            </a>
          ) : (
            <span class="text-small">Repo not yet added</span>
          )}
        </div>
      </Card>
    </>
  ) : (
    <Card>
      <h2>Game not found</h2>
      <p class="text-small">Use the labs list to open an available game.</p>
      <a class="button" href="/labs">Back to Labs</a>
    </Card>
  )}
</BaseLayout>
