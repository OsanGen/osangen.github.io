---
import ProofIOBlock from './ProofIOBlock.astro';
import type { GPT } from '../lib/schemas';

export interface Props {
  gpt: GPT;
  revealDelayMs?: number;
}

const { gpt, revealDelayMs = 0 } = Astro.props;

const isUnavailableLink = (value = '') => {
  const normalized = value.trim().toLowerCase();
  return !normalized || /xxxxx|placeholder|todo|temp/.test(normalized);
};

const linkAttrs = (url: string) => {
  const href = url.trim();
  const available = !isUnavailableLink(href);
  return {
    href,
    available,
    isExternal: available && /^https?:\/\//.test(href),
  };
};

const statusLabel = gpt.status === 'active' ? 'Active' : gpt.status === 'prototype' ? 'Prototype' : 'Archived';
const audienceLine = gpt.audience.length > 0 ? gpt.audience.join(' / ') : 'General';

const use = linkAttrs(gpt.links.use);
const promptPack = linkAttrs(gpt.links.promptPack);
const demo = linkAttrs(gpt.links.demo);
---
<article
  class="panel-shell panel-shell--command cog-entrance"
  style={`--reveal-delay:${revealDelayMs}ms`}
  data-gpt-card
  data-gpt-id={gpt.id}
  data-status={gpt.status}
  data-tags={gpt.tags.map((tag) => tag.toLowerCase()).join(',')}
  data-audience={gpt.audience.map((aud) => aud.toLowerCase()).join(',')}
>
  <div class="micro-rail" aria-hidden="true"></div>
  <div class="command-line">
    <p class="proof-chip proof-chip--status">Status: {statusLabel}</p>
    <p class="proof-meta">{audienceLine}</p>
  </div>
  <div class="gpt-title-row">
    {gpt.icon ? <img src={gpt.icon.src} alt={gpt.icon.alt} class="gpt-icon" loading="lazy" decoding="async" /> : null}
    <h2>{gpt.name}</h2>
  </div>
  <p class="proof-meta">
    Outcome: {gpt.ships}
  </p>

  <p class="proof-headline">Claim</p>
  <p>{gpt.promise}</p>

  <p class="proof-headline">Proof</p>
  <ProofIOBlock proof={gpt.proof} />

  <p class="proof-headline">How to use</p>
  <ol class="gpt-steps">
    {gpt.how_to_use.map((step) => <li>{step}</li>)}
  </ol>

  <p class="proof-headline">Limits</p>
  <ul class="gpt-limits">
    {gpt.limits.map((limit) => <li>{limit}</li>)}
  </ul>

  <p class="proof-headline">Next step</p>
  <p class="proof-meta">Start with your highest-risk process and keep one checkpoint per cycle.</p>

  <div class="cta-stack" style="margin-top:0.75rem;">
    {use.available ? (
      <a
        href={use.href}
        class="button"
        target={use.isExternal ? '_blank' : undefined}
        rel={use.isExternal ? 'noopener noreferrer' : undefined}
      >
        Use this GPT
      </a>
    ) : (
      <span class="button button--muted" aria-disabled="true">Request access</span>
    )}
    {promptPack.available ? (
      <a
        href={promptPack.href}
        class="button"
        target={promptPack.isExternal ? '_blank' : undefined}
        rel={promptPack.isExternal ? 'noopener noreferrer' : undefined}
      >
        Prompt pack
      </a>
    ) : (
      <span class="button button--muted" aria-disabled="true">Prompt pack pending</span>
    )}
    {demo.available ? (
      <a
        href={demo.href}
        class="button"
        target={demo.isExternal ? '_blank' : undefined}
        rel={demo.isExternal ? 'noopener noreferrer' : undefined}
      >
        Open demo
      </a>
    ) : (
      <span class="button button--muted" aria-disabled="true">Demo pending</span>
    )}
  </div>

  <div class="tag-list" aria-label="Tags" style="margin-top:0.75rem;">
    {gpt.tags.map((tag) => <span class="badge">{tag}</span>)}
  </div>
</article>
