# Component Spec: `public/sw.js` + `src/components/ServiceWorkerRegister.astro`

## Purpose
Implement a lightweight runtime performance layer with service worker caching to reduce repeated network cost, improve repeat navigation speed, and support graceful offline behavior.

## Inputs / Outputs
- Input:
  - Browser requests for navigations and same-origin static assets.
  - `BaseLayout.astro` mounting point (`ServiceWorkerRegister` component).
  - Build-time `PUBLIC_SW_VERSION` propagated into service worker registration URL query.
- Output:
  - Registered service worker lifecycle (`install`, `activate`, `fetch`) orchestration.
  - Cache-first asset responses (with critical brand logo network-first refresh) and network-first documents with cache fallback.
  - Deploy-driven cache namespace rotation keyed by SW query-version.

## State
- Three named caches:
- `osan-core-<version>`
- `osan-assets-<version>`
- `osan-documents-<version>`
- In-memory state handled by the browser cache API and client-controlled update flow.
- `VERSION` is derived at runtime from `self.location.href` query param (`?v=`) and normalized for cache key safety.
- `ServiceWorkerRegister` now triggers `update()` after registration to reduce stale worker runtime.

## Edge cases
- Pre-cache failures for unavailable routes are tolerated and ignored.
- Network failures for navigations/pages fall back to cached document for last known availability.
- Off-origin requests are ignored by the worker so CDN/API calls are unaffected.
- Registration failures are caught and intentionally non-fatal in constrained browsers.
- Navigation fetches use `cache: 'no-store'` before fallback to reduce stale HTML under transient cache states.
- Missing `PUBLIC_SW_VERSION` in local/dev falls back to `local` so registration remains deterministic.

## Dependencies
- `src/layouts/BaseLayout.astro` (for injection in every shell page).
- `public/manifest.webmanifest` (install metadata used in browser install flow).
- Browser Cache API/Service Worker APIs.

## Acceptance checks
- Service worker is registered exactly once from shared layout.
- Registration URL includes `?v=<PUBLIC_SW_VERSION>` in CI/deploy builds and `?v=local` in local/dev fallback.
- Static script/style/font/image/font/svg/json/text/xml/txt requests use cache-first strategy, with canonical lockup assets (`/icons/osan-logo-v2*.png`) explicitly routed through network-first for faster brand-propagation and brand-change visibility.
- Document requests use network-first with stale fallback.
- New routes remain accessible under normal connectivity and degrade gracefully offline.
