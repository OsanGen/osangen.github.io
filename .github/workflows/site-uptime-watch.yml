name: Site uptime watch

permissions:
  contents: read
  issues: write

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  watch-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Check homepage and GPT route
        run: |
          set -euo pipefail
          for url in https://osangen.github.io/ https://osangen.github.io/gpts; do
            code=$(curl -sS -L --max-redirs 3 -o /dev/null -w '%{http_code}' "$url")
            if [ "$code" != "200" ]; then
              echo "Endpoint check failed: $url returned $code"
              exit 1
            fi
          done
      - name: Open or update outage issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Automated site uptime check failed';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const query = `repo:${{ github.repository }} is:issue is:open \"${title}\"`;
            const { data } = await github.rest.search.issuesAndPullRequests({ q: query, per_page: 1 });
            if (data.total_count > 0) {
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: `Site uptime monitor detected a failed request.\n\nCheck details:\n${runUrl}\n`,
              labels: ['uptime-watch'],
            });
